# Architecture — copyp-finance

## Цель проекта
Telegram-бот для учёта личных/семейных финансов: хранение пользователей, целей/бюджетов, операций (доход/расход), отчётов и служебных событий.  
Проект рассчитан на развитие: сначала каркас + БД + базовые команды, затем расширение логики.

---

## Технологический стек

### Telegram / Bot layer
- **aiogram 3** — асинхронный фреймворк для Telegram-ботов.
- Назначение: принять апдейты, распарсить команды/сообщения, вызвать бизнес-логику, вернуть ответ.

### Backend / Business logic
- **Python 3.12**
- Слои:
  - handlers (в bot/) — минимальная логика, маршрутизация
  - services — бизнес-правила, транзакции, валидации, сценарии

### Database
- **PostgreSQL** — основное хранилище данных.
- **SQLAlchemy 2.x (async)** — ORM и слой доступа к данным.
- **asyncpg** — драйвер подключения к Postgres в async-режиме.

### Миграции
- **Alembic** — ведёт историю изменений схемы БД, генерирует и применяет миграции.

### Конфигурация
- **pydantic-settings** — загрузка настроек из `.env` / переменных окружения.
- Разделение:
  - DB-настройки отдельно
  - App-настройки отдельно (token, env, log-level, timezone и т.п.)

### Контейнеризация и деплой
- **Docker / Docker Compose** — сборка и запуск приложения.
- На сервере:
  - сервис systemd поднимает `docker compose up -d --build`
  - Postgres может жить на хосте (как сейчас) или в отдельном контейнере (возможная альтернатива позже)

---

## Архитектурные принципы

### 1) Слой Telegram не содержит бизнес-логики
**bot/** отвечает только за:
- приём входящих сообщений/команд
- выбор handler’а
- вызов service
- формирование ответа пользователю

Нельзя:
- делать SQL-запросы прямо в handler’ах
- “размазывать” бизнес-правила по роутерам

### 2) Вся бизнес-логика — в services
**services/** — это “сценарии”:
- create_user_if_needed
- add_transaction
- set_budget
- build_daily_report
и т.п.

Services:
- принимают входные параметры
- используют репозитории/DAO (или напрямую session + модели на первых этапах)
- возвращают доменные результаты (данные для ответа)

### 3) Модели данных отделены от логики
**db/models/** — только описание таблиц (ORM-модели).
В моделях допускаются:
- поля, индексы, ограничения
- простые методы-конструкторы (по желанию)
Но бизнес-правила — в services.

### 4) Миграции — единственный источник правды о схеме
**migrations/** + `alembic.ini`:
- схема БД меняется только через `alembic revision` + `alembic upgrade`
- в проде миграции применяются осознанно (отдельной командой/шагом)

### 5) Конфигурация централизована
Код не читает `.env` напрямую.  
Настройки берутся из `core/settings_*.py` через экземпляры settings.

---

## Потоки данных (как “идёт запрос”)

### A) Старт и инициализация
1. Docker поднимает контейнер приложения
2. Приложение читает настройки (token, db параметры)
3. Создаёт engine/sessionmaker
4. Запускает aiogram polling/webhook (зависит от режима)

### B) Обработка сообщения пользователя
1. Пользователь пишет в Telegram
2. aiogram роутит сообщение в handler
3. handler вызывает service (например, `UserService.ensure_user`)
4. service обращается к БД (через session + модели)
5. handler формирует текст ответа и отправляет

---

## Схема деплоя (текущая)

### Текущий вариант
- Postgres установлен на **хосте**
- Контейнер бота ходит в Postgres по адресу хоста (через `host.docker.internal` или через IP шлюза docker)
- Systemd управляет жизненным циклом compose-стека

Плюсы:
- простая эксплуатация БД на одном сервере
- бэкапы/настройки Postgres стандартные

Минусы:
- нужно аккуратно настроить доступ контейнера к хостовой БД

### Альтернатива (позже, если захотим)
- Postgres в docker-compose как отдельный сервис
Плюсы:
- единый compose-стек, легче переносить
Минусы:
- надо правильно организовать volume и бэкапы

---

## Границы ответственности каталогов (в терминах проекта)
- `bot/` — Telegram слой (handlers/routers/middlewares)
- `services/` — бизнес-логика (сценарии и правила)
- `db/` — ORM-модели, engine, sessionmaker, базовые утилиты доступа к данным
- `core/` — настройки, логирование, общие утилиты инфраструктуры
- `migrations/` — Alembic окружение и версии миграций
- `docs/` — документация (архитектура, структура, промпты, UX/шаблоны)

---

## Правила расширения проекта
1. Новая фича начинается с решения:
   - какие сущности БД нужны
   - какие сервисы будут
   - какие команды/handlers появятся
2. Сначала модели + миграции, затем сервисы, затем handlers
3. Любые изменения структуры папок фиксируются в `docs/project_structure.md`

