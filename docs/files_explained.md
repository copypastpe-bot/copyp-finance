# Files Explained — зачем нужны файлы проекта

Этот документ **объясняет назначение ключевых файлов и папок проекта простым языком**.
Он не дублирует `project_structure.md`, а отвечает на другой вопрос:

> **Почему эти файлы существуют и что сломается, если их убрать или сделать иначе**

---

## 1. `core/` — настройки и базовая конфигурация

### `core/settings_db.py`
**Зачем:**
- Читает параметры подключения к базе данных из `.env`
- Даёт приложению единый источник правды о БД

**Почему отдельно от app-настроек:**
- Alembic и SQLAlchemy должны уметь работать с БД **без запуска бота**
- Если смешать с `bot_token`, Alembic будет падать

**Если убрать / сломать:**
- Alembic не сможет подключиться к БД
- Миграции перестанут работать

---

### `core/settings_app.py`
**Зачем:**
- Хранит настройки самого приложения (бот, логирование, окружение)
- Используется только при запуске бота

**Важно:**
- Здесь **нет** DB-полей
- Это сделано специально, чтобы Alembic не зависел от Telegram

---

## 2. `db/` — слой базы данных (ORM)

### `db/base.py`
```python
from sqlalchemy.orm import DeclarativeBase

class Base(DeclarativeBase):
    pass
```

**Почему файл такой маленький:**
- Он выполняет **одну критически важную роль**
- Это корень для всех ORM-моделей

**Что происходит на самом деле:**
- Все модели (`User`, `Transaction`, и т.д.) наследуются от `Base`
- SQLAlchemy собирает все таблицы в `Base.metadata`
- Alembic читает `Base.metadata`, чтобы понять, какие таблицы должны быть в БД

**Если удалить:**
- Alembic перестанет видеть модели
- `autogenerate` будет создавать пустые миграции

---

### `db/models/`
Папка с ORM-моделями (таблицами БД)

#### `db/models/user.py`
```python
class User(Base):
    __tablename__ = "users"

    id = ...
    tg_user_id = ...
    created_at = ...
```

**Зачем:**
- Описывает таблицу `users`
- Каждое поле = колонка в PostgreSQL

**Почему так много аннотаций:**
- `Mapped[...]` — чтобы SQLAlchemy понимал типы
- `mapped_column(...)` — явное описание колонки

**Что важно:**
- `tg_user_id` — уникальный ID Telegram пользователя
- `created_at` создаётся на стороне БД (`now()`), а не Python

---

### `db/models/__init__.py`
**Зачем:**
- Импортирует все модели
- Используется Alembic

```python
from .user import User
```

Если модель не импортирована здесь:
- Alembic её не увидит
- Таблица не появится в миграциях

---

## 3. `migrations/` — Alembic (миграции БД)

### `migrations/env.py`
**Это самый сложный файл проекта. И это нормально.**

**Зачем:**
- Подключает Alembic к БД
- Сообщает Alembic, **какие модели существуют**
- Умеет работать в async-режиме

Ключевые идеи:
- Берёт URL БД из `settings_db`
- Загружает `Base.metadata`
- Запускает миграции через async engine

**Если тут ошибка:**
- Миграции не работают
- БД не обновляется

---

### `migrations/versions/*.py`
**Зачем:**
- Каждая версия = шаг эволюции БД
- Генерируются Alembic автоматически

Пример:
- `create users`
- `add transactions`

**Важно:**
- Эти файлы **коммитятся в git**
- Это история базы данных

---

### `alembic.ini`
**Зачем:**
- Конфигурация Alembic
- Указывает, где лежат миграции

Без него:
- Alembic не стартует

---

## 4. `bot/` — Telegram-бот

### `bot/main.py`
**Зачем:**
- Точка входа
- Инициализация бота
- Регистрация хендлеров

Пока здесь минимум логики — и это правильно.

---

## 5. `.env`
**Зачем:**
- Хранит секреты и конфигурацию
- Не коммитится в git

Пример:
```env
BOT_TOKEN=...
DB_HOST=...
```

---

## Итоговая картина

- `core/` — настройки
- `db/` — описание данных
- `migrations/` — история БД
- `bot/` — пользовательская логика

Каждый слой:
- решает **одну задачу**
- не лезет в чужую ответственность

---

Этот файл — **учебный**.
Следующий шаг — `codex_prompt.md`, где мы объясним ИИ:
- как читать эти документы
- как правильно продолжать разработку

